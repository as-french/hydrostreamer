<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>hydrostreamer tutorial • hydrostreamer</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js" integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha256-916EbMg70RQy9LHiGkXzG8hSg9EdNy97GazNG/aiY1w=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha256-U5ZEeKfGNOja007MMD3YBI0A3OSZOQbeG6z2f2Y0hu8=" crossorigin="anonymous"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css" integrity="sha256-eZrrJcwDc/3uDhsdt61sL2oOBY362qM3lon1gyExkL0=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.4/clipboard.min.js" integrity="sha256-FiZwavyI2V6+EXO1U+xzLG3IKldpiTFf3153ea9zikQ=" crossorigin="anonymous"></script><!-- sticky kit --><script src="https://cdnjs.cloudflare.com/ajax/libs/sticky-kit/1.1.3/sticky-kit.min.js" integrity="sha256-c4Rlo1ZozqTPE2RLuvbusY3+SU1pQaJC0TjuhygMipw=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="hydrostreamer tutorial">
<meta property="og:description" content="">
<meta name="twitter:card" content="summary">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">hydrostreamer</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">0.4.0</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fa fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/hydrostreamer_simple_tutorial.html">hydrostreamer tutorial</a>
    </li>
  </ul>
</li>
<li>
  <a href="../news/index.html">Changelog</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right"></ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      
      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1>hydrostreamer tutorial</h1>
                        <h4 class="author">Marko Kallio</h4>
            
            <h4 class="date">2019-04-10</h4>
      
      
      <div class="hidden name"><code>hydrostreamer_simple_tutorial.Rmd</code></div>

    </div>

    
    
<p>The development of ‘hydrostreamer’ was inspired by a study, where one component was estimating water availability in rural villages. In that study, water availability was estimated using a regional distributed hydrological model with 5km grid resolution. The problem in the study was how it represented the available water quantity at a village. First, the grid size was too coarse to represent the stream network accurately. A regional model with 5km grid size is quite fine, but for a village level estimates where distance to water source was an important attribute. Field representation (which raster in essence is) was not satisfactory.</p>
<p>Hence, <em>hydrostreamer</em> was conceived. <em>hydrostreamer</em> takes an off-the-shelf runoff product of an arbitrary resolution, and assigns runoff to an explicitly represented river network. To keep things simple and approachable, there is no runoff modelling involved in the use of <em>hydrostreamer</em>, rather, it post-processes results from either hydrological or land surface models and with minimal input requirements. The concept of <em>hydrostreamer</em> is very simple and easy to grasp, with a design philosophy that it should be easy to use for anyone, without background in hydrology.</p>
<p>In practise, similar ideas have been used in a number of existing solutions; for instance river routing software HydroROUT, <a href="https://github.com/c-h-david/rapid/">RAPID</a>, or <a href="https://github.com/NCAR/mizuRoute">mizuRoute</a>. These also take off-the-shelf runoff products, and apply river routing algorithms to predict streamflow at explicit (vector) river segments. What sets <em>hydrostreamer</em> apart from these solutions is that it is written in R, is easy to install and use, and most importantly, focus is not in river routing, but in the downscaling step.</p>
<p>This tutorial aims to explain the workflow in <em>hydrostreamer</em> and showcase some of it’s capabilities. More specific tutorials will be added in time, which concentrate on different parts of hydrostreamer</p>
<div id="using-hydrostreamer" class="section level1">
<h1 class="hasAnchor">
<a href="#using-hydrostreamer" class="anchor"></a>Using <strong>hydrostreamer</strong>
</h1>
<p>Some example data have been included to the package for tutorial purposes. It includes</p>
<ul>
<li><p>1 by 1 degree DEM at located in Southeast Asia. The DEM is originally ALOS World 3D at 30 meter resolution (Tanado et al 2014), which has been resampled to 0.005 degree resolution.</p></li>
<li><p>1 by 1 degree runoff timeseries in the same area as the DEM. Runoff is sourced from the Linear Optimal Runoff Aggregate (LORA) at 0.5 degree resolution (see Hobeichi et al 2019). The unit of runoff is mm/s (kg/m2/s), and are provided with a monthly timestep.</p></li>
<li><p>A river network derived from the provided DEM with 216 river segments.</p></li>
<li><p>River segment specific catchment areas, delineated from the provided DEM. Catchments are provided for a subset (n = 41) of the river segments.</p></li>
</ul>
<p>Let’s first load the data and inspect it:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/library">library</a></span>(hydrostreamer)
<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/library">library</a></span>(raster)
<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/library">library</a></span>(lubridate)
<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/library">library</a></span>(dplyr)
<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/library">library</a></span>(ggplot2)
<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/library">library</a></span>(tidyr)

<span class="kw"><a href="https://www.rdocumentation.org/packages/utils/topics/data">data</a></span>(example_rivers)
<span class="kw"><a href="https://www.rdocumentation.org/packages/utils/topics/data">data</a></span>(example_basins)
runoff &lt;-<span class="st"> </span><span class="kw">brick</span>(<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/system.file">system.file</a></span>(<span class="st">"extdata"</span>, <span class="st">"runoff.tif"</span>, <span class="dt">package =</span> <span class="st">"hydrostreamer"</span>))
<span class="kw"><a href="https://www.rdocumentation.org/packages/utils/topics/data">data</a></span>(example_dem)

<span class="kw"><a href="https://www.rdocumentation.org/packages/graphics/topics/plot">plot</a></span>(runoff[[<span class="dv">1</span>]]) 
<span class="kw"><a href="https://www.rdocumentation.org/packages/graphics/topics/plot">plot</a></span>(<span class="kw">st_union</span>(basins), <span class="dt">add=</span><span class="ot">TRUE</span>)
<span class="kw"><a href="https://www.rdocumentation.org/packages/graphics/topics/plot">plot</a></span>(river, <span class="dt">add=</span><span class="ot">TRUE</span>)</code></pre></div>
<p><img src="hydrostreamer_simple_tutorial_files/figure-html/unnamed-chunk-1-1.png" width="700"></p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">
<span class="kw"><a href="https://www.rdocumentation.org/packages/graphics/topics/plot">plot</a></span>(dem)
<span class="kw"><a href="https://www.rdocumentation.org/packages/graphics/topics/plot">plot</a></span>(<span class="kw">st_union</span>(basins), <span class="dt">add=</span><span class="ot">TRUE</span>)
<span class="kw"><a href="https://www.rdocumentation.org/packages/graphics/topics/plot">plot</a></span>(river, <span class="dt">add=</span><span class="ot">TRUE</span>)</code></pre></div>
<p><img src="hydrostreamer_simple_tutorial_files/figure-html/unnamed-chunk-1-2.png" width="700"></p>
<p><em>hydrostreamer</em> main workflow occurs in four steps (and four functions):</p>
<ol style="list-style-type: decimal">
<li>Convert the runoff timeseries to a HSgrid object</li>
<li>Compute weights for each river segment</li>
<li>Downscale runoff</li>
<li>Apply river routing</li>
</ol>
<div id="converting-raster-runoff-to-a-polygon-network" class="section level2">
<h2 class="hasAnchor">
<a href="#converting-raster-runoff-to-a-polygon-network" class="anchor"></a>1. Converting raster runoff to a polygon network</h2>
<p>The raster layers are converted to polygons in order to do all the computations using only vector processing. Each cell of the raster is polygonized, and if an area of interest is provided, the polygons are clipped to it. This removes any unneeded grid cells. The resulting <strong>HSgrid</strong> object is a standard ‘sf’ object with information about each raster cell. The runoff timeseries (a <a href="https://github.com/tidyverts/tsibble">tsibble</a>) can be found in a named list column <em>runoff_ts</em>. The elements are named by the ID, and can be accessed with the ‘$’ notation.</p>
<p>We use <strong>raster_to_HSgrid</strong> to convert a raster timeseries to a HSgrid. Below, runoff is a <em>RasterBrick</em>, date is the date of the first layer in runoff, aoi is the area of interest.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">HSgrid &lt;-<span class="st"> </span><span class="kw"><a href="../reference/raster_to_HSgrid.html">raster_to_HSgrid</a></span>(runoff, 
                         <span class="dt">date =</span> <span class="kw">ymd</span>(<span class="st">"1980-01-01"</span>), 
                         <span class="dt">timestep =</span> <span class="st">"month"</span>, 
                         <span class="dt">aoi =</span> <span class="kw">st_union</span>(basins),
                         <span class="dt">names =</span> <span class="st">"LORA"</span>)
<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/names">names</a></span>(HSgrid)
<span class="co">#&gt; [1] "gridID"    "runoff_ts" "area_m2"   "n_ts"      "geometry"</span>
<span class="kw"><a href="https://www.rdocumentation.org/packages/graphics/topics/plot">plot</a></span>(HSgrid[,<span class="st">"area_m2"</span>])</code></pre></div>
<p><img src="hydrostreamer_simple_tutorial_files/figure-html/unnamed-chunk-2-1.png" width="700"></p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">HSgrid<span class="op">$</span>runoff_ts<span class="op">$</span><span class="st">`</span><span class="dt">1</span><span class="st">`</span>
<span class="co">#&gt; # A tsibble: 396 x 2 [1D]</span>
<span class="co">#&gt;    Date              LORA</span>
<span class="co">#&gt;    &lt;date&gt;           &lt;dbl&gt;</span>
<span class="co">#&gt;  1 1980-01-01 0.00000344 </span>
<span class="co">#&gt;  2 1980-02-01 0.00000166 </span>
<span class="co">#&gt;  3 1980-03-01 0.000000993</span>
<span class="co">#&gt;  4 1980-04-01 0.000000874</span>
<span class="co">#&gt;  5 1980-05-01 0.000000815</span>
<span class="co">#&gt;  6 1980-06-01 0.0000279  </span>
<span class="co">#&gt;  7 1980-07-01 0.0000185  </span>
<span class="co">#&gt;  8 1980-08-01 0.0000503  </span>
<span class="co">#&gt;  9 1980-09-01 0.0000815  </span>
<span class="co">#&gt; 10 1980-10-01 0.0000557  </span>
<span class="co">#&gt; # ... with 386 more rows</span></code></pre></div>
<p>HSgrid can also be created from an ‘sf’ (polygon) object and a runoff timeseries using function <a href="https://mkkallio.github.io/hydrostreamer/reference/create_HSweights.html">create_HSgrid</a>.</p>
</div>
<div id="compute-weights-for-downscaling" class="section level2">
<h2 class="hasAnchor">
<a href="#compute-weights-for-downscaling" class="anchor"></a>2. Compute weights for downscaling</h2>
<p>Once the raster has been converted to <em>HSgrid</em>, we can compute the weights. <em>compute_HSweights()</em> provides a possibility to weight the segments by their respective catchment area, or by using river segment properties. In this tutorial we will use the provided catchment areas, and the river network itself to compute the weights.</p>
<p>Below we provide five arguments to the segment weighting: <em>HSgrid</em> - which we just created in the previous step, <em>river</em> - the river network, <em>“length”</em> for weights - we’ll use the river segment length as the basis of weighting, union of <em>basins</em> for area of interest - because we want only river segments within the area of interest. Finally, we tell the function that the river contains unique ID’s in the column called <em>“SEGMENT_ID”</em>.</p>
<p>For catchment-based weighting, the only difference is that the weights argument gets value <em>“area”</em>, and we provide the <em>basins</em> object to the argument with the same name.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">river_weights &lt;-<span class="st"> </span><span class="kw"><a href="../reference/compute_HSweights.html">compute_HSweights</a></span>(HSgrid, 
                                   river, 
                                   <span class="dt">weights =</span> <span class="st">"length"</span>,
                                   <span class="dt">aoi =</span> <span class="kw">st_union</span>(basins),
                                   <span class="dt">riverID =</span> <span class="st">"SEGMENT_ID"</span>)

catchment_weights &lt;-<span class="st"> </span><span class="kw"><a href="../reference/compute_HSweights.html">compute_HSweights</a></span>(HSgrid, 
                                       river, 
                                       <span class="dt">weights =</span> <span class="st">"area"</span>,
                                       <span class="dt">basins =</span> basins,
                                       <span class="dt">aoi =</span> <span class="kw">st_union</span>(basins),
                                       <span class="dt">riverID =</span> <span class="st">"SEGMENT_ID"</span>)</code></pre></div>
<p>To illustrate the differences between these two approaches, we can plot the <strong>weights</strong> element in the resulting <em>HSweights</em> object.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw"><a href="https://www.rdocumentation.org/packages/graphics/topics/par">par</a></span>(<span class="dt">mfrow=</span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>(<span class="dv">1</span>,<span class="dv">2</span>))
<span class="kw"><a href="https://www.rdocumentation.org/packages/graphics/topics/plot">plot</a></span>(river_weights<span class="op">$</span>weights[,<span class="st">"gridID"</span>], <span class="dt">reset=</span><span class="ot">FALSE</span>)
<span class="kw"><a href="https://www.rdocumentation.org/packages/graphics/topics/plot">plot</a></span>(<span class="kw">st_union</span>(basins), <span class="dt">add=</span><span class="ot">TRUE</span>)</code></pre></div>
<p><img src="hydrostreamer_simple_tutorial_files/figure-html/unnamed-chunk-4-1.png" width="700"></p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw"><a href="https://www.rdocumentation.org/packages/graphics/topics/plot">plot</a></span>(catchment_weights<span class="op">$</span>weights[,<span class="st">"gridID"</span>])</code></pre></div>
<p><img src="hydrostreamer_simple_tutorial_files/figure-html/unnamed-chunk-4-2.png" width="700"></p>
<p>The river segments and catchments are split at the borders of the runoff polygons. Weights are then divided among the river segments within each individual runoff polygon. The weights inside each runoff polygon always add to 1.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw"><a href="https://www.rdocumentation.org/packages/graphics/topics/par">par</a></span>(<span class="dt">mfrow=</span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>(<span class="dv">1</span>,<span class="dv">2</span>))
<span class="kw"><a href="https://www.rdocumentation.org/packages/graphics/topics/plot">plot</a></span>(river_weights<span class="op">$</span>weights[,<span class="st">"weights"</span>], <span class="dt">reset=</span><span class="ot">FALSE</span>)
<span class="kw"><a href="https://www.rdocumentation.org/packages/graphics/topics/plot">plot</a></span>(<span class="kw">st_union</span>(basins), <span class="dt">add=</span><span class="ot">TRUE</span>)</code></pre></div>
<p><img src="hydrostreamer_simple_tutorial_files/figure-html/unnamed-chunk-5-1.png" width="700"></p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw"><a href="https://www.rdocumentation.org/packages/graphics/topics/plot">plot</a></span>(catchment_weights<span class="op">$</span>weights[,<span class="st">"weights"</span>])</code></pre></div>
<p><img src="hydrostreamer_simple_tutorial_files/figure-html/unnamed-chunk-5-2.png" width="700"></p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">
river_weights<span class="op">$</span>weights <span class="op">%&gt;%</span>
<span class="st">    </span><span class="kw">group_by</span>(gridID) <span class="op">%&gt;%</span>
<span class="st">    </span><span class="kw">summarise</span>(<span class="dt">sum_of_weights =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/sum">sum</a></span>(weights))
<span class="co">#&gt; Simple feature collection with 4 features and 2 fields</span>
<span class="co">#&gt; geometry type:  MULTILINESTRING</span>
<span class="co">#&gt; dimension:      XY</span>
<span class="co">#&gt; bbox:           xmin: 107.3325 ymin: 12.2975 xmax: 107.6075 ymax: 12.995</span>
<span class="co">#&gt; epsg (SRID):    4326</span>
<span class="co">#&gt; proj4string:    +proj=longlat +datum=WGS84 +no_defs</span>
<span class="co">#&gt; # A tibble: 4 x 3</span>
<span class="co">#&gt;   gridID sum_of_weights                                                geom</span>
<span class="co">#&gt;    &lt;int&gt;          &lt;dbl&gt;                              &lt;MULTILINESTRING [Â°]&gt;</span>
<span class="co">#&gt; 1      1              1 ((107.4325 12.5, 107.4325 12.5025), (107.43 12.5, ~</span>
<span class="co">#&gt; 2      2              1 ((107.6 12.5, 107.5975 12.5025, 107.6025 12.5075, ~</span>
<span class="co">#&gt; 3      3              1 ((107.4125 12.2975, 107.4075 12.3025, 107.4025 12.~</span>
<span class="co">#&gt; 4      4              1 ((107.5925 12.4475, 107.5875 12.4525, 107.5875 12.~</span></code></pre></div>
<p>The other elements of <em>HSweights</em> are the (routed) river network and the <em>HSgrid</em> object provided in the input to thhe constructing function.</p>
</div>
<div id="downscale-runoff" class="section level2">
<h2 class="hasAnchor">
<a href="#downscale-runoff" class="anchor"></a>3. downscale runoff</h2>
<p>Once a <em>HSweights</em> object has been created, we can apply the actual downscaling. The function condences the three elements of <em>HSweights</em> into an ‘sf’ object containing the river routing information, downscaled runoff timeseries (the unit is converted from a field, mm/s, to volume, m^3/s).</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">catchment_downscaled &lt;-<span class="st"> </span><span class="kw"><a href="../reference/downscale_runoff.html">downscale_runoff</a></span>(catchment_weights)
( river_downscaled &lt;-<span class="st"> </span><span class="kw"><a href="../reference/downscale_runoff.html">downscale_runoff</a></span>(river_weights) )
<span class="co">#&gt; </span>
<span class="co">#&gt; Hydrostreamer</span>
<span class="co">#&gt; No. objects: 41</span>
<span class="co">#&gt; No. runoff inputs: 2</span>
<span class="co">#&gt;   Included runoff timeseries: [1] "LORA"</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Simple feature collection with 41 features and 5 fields</span>
<span class="co">#&gt; geometry type:  LINESTRING</span>
<span class="co">#&gt; dimension:      XY</span>
<span class="co">#&gt; bbox:           xmin: 107.3325 ymin: 12.2975 xmax: 107.6075 ymax: 12.9975</span>
<span class="co">#&gt; epsg (SRID):    4326</span>
<span class="co">#&gt; proj4string:    +proj=longlat +datum=WGS84 +no_defs</span>
<span class="co">#&gt; # A tibble: 41 x 6</span>
<span class="co">#&gt;    riverID  NEXT PREVIOUS  runoff_ts UP_SEGMENTS                       geom</span>
<span class="co">#&gt;      &lt;dbl&gt; &lt;dbl&gt; &lt;list&gt;    &lt;list&gt;          &lt;dbl&gt;          &lt;LINESTRING [Â°]&gt;</span>
<span class="co">#&gt;  1      56    70 &lt;dbl [1]&gt; &lt;tsibble~           1 (107.4125 12.2975, 107.40~</span>
<span class="co">#&gt;  2      65    99 &lt;dbl [1]&gt; &lt;tsibble~           1 (107.4425 12.3425, 107.43~</span>
<span class="co">#&gt;  3      67    83 &lt;dbl [1]&gt; &lt;tsibble~           1 (107.5475 12.3625, 107.54~</span>
<span class="co">#&gt;  4      69    70 &lt;dbl [1]&gt; &lt;tsibble~           1 (107.3525 12.3675, 107.35~</span>
<span class="co">#&gt;  5      70   102 &lt;dbl [2]&gt; &lt;tsibble~           3 (107.3675 12.3725, 107.37~</span>
<span class="co">#&gt;  6      77    89 &lt;dbl [1]&gt; &lt;tsibble~           1 (107.5175 12.4125, 107.51~</span>
<span class="co">#&gt;  7      79    83 &lt;dbl [1]&gt; &lt;tsibble~           1 (107.5625 12.4275, 107.55~</span>
<span class="co">#&gt;  8      83    89 &lt;dbl [2]&gt; &lt;tsibble~           3 (107.5575 12.4375, 107.56~</span>
<span class="co">#&gt;  9      85   109 &lt;dbl [1]&gt; &lt;tsibble~           1 (107.5925 12.4475, 107.58~</span>
<span class="co">#&gt; 10      88    99 &lt;dbl [1]&gt; &lt;tsibble~           1 (107.4525 12.4575, 107.44~</span>
<span class="co">#&gt; # ... with 31 more rows</span></code></pre></div>
<p>The downscaled runoff in <em>runoff_ts</em> is a named list column where each element is a <em>tsibble</em>. Like with HSgrid, each element can be accessed by its name - the ID of the river segment.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">( runoff200 &lt;-<span class="st"> </span>catchment_downscaled<span class="op">$</span>runoff_ts<span class="op">$</span><span class="st">`</span><span class="dt">200</span><span class="st">`</span> )
<span class="co">#&gt; # A tsibble: 396 x 2 [1D]</span>
<span class="co">#&gt;    Date           LORA</span>
<span class="co">#&gt;    &lt;date&gt;        &lt;dbl&gt;</span>
<span class="co">#&gt;  1 1980-01-01 0.00310 </span>
<span class="co">#&gt;  2 1980-02-01 0.00150 </span>
<span class="co">#&gt;  3 1980-03-01 0.000894</span>
<span class="co">#&gt;  4 1980-04-01 0.000787</span>
<span class="co">#&gt;  5 1980-05-01 0.000734</span>
<span class="co">#&gt;  6 1980-06-01 0.0251  </span>
<span class="co">#&gt;  7 1980-07-01 0.0166  </span>
<span class="co">#&gt;  8 1980-08-01 0.0453  </span>
<span class="co">#&gt;  9 1980-09-01 0.0733  </span>
<span class="co">#&gt; 10 1980-10-01 0.0502  </span>
<span class="co">#&gt; # ... with 386 more rows</span></code></pre></div>
<p>We can compare the downscaled results from the two approaches.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">plotdata &lt;-<span class="st"> </span><span class="kw">left_join</span>(runoff200, 
                      river_downscaled<span class="op">$</span>runoff_ts<span class="op">$</span><span class="st">`</span><span class="dt">200</span><span class="st">`</span>,
                      <span class="dt">by=</span><span class="st">"Date"</span>)
<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/colnames">colnames</a></span>(plotdata) &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>(<span class="st">"Date"</span>, <span class="st">"Catchment"</span>, <span class="st">"River"</span>)
plotdata &lt;-<span class="st"> </span><span class="kw">gather</span>(plotdata, 
                   Approach,
                   Runoff,
                   <span class="op">-</span>Date)

<span class="kw">ggplot</span>(plotdata, <span class="kw">aes</span>(Date, Runoff, <span class="dt">color=</span>Approach)) <span class="op">+</span><span class="st"> </span>
<span class="st">    </span><span class="kw">geom_line</span>() <span class="op">+</span>
<span class="st">    </span><span class="kw">labs</span>(<span class="dt">title =</span> <span class="st">"Downscaled runoff at river segment 200"</span>,
         <span class="dt">y =</span> <span class="st">'Runoff in m3/s'</span>,
         <span class="dt">x =</span> <span class="ot">NULL</span>)</code></pre></div>
<p><img src="hydrostreamer_simple_tutorial_files/figure-html/unnamed-chunk-8-1.png" width="700"></p>
</div>
<div id="apply-river-routing" class="section level2">
<h2 class="hasAnchor">
<a href="#apply-river-routing" class="anchor"></a>4. Apply river routing</h2>
<p>While the downscaled runoff at each river segment is already useful for many applications, often knowing river discharge is also desirable. <em>hydrostreamer</em> provides three simple river routing algorithms for this purpose: <strong>instantaneous</strong> routing, useful for e.g. estimating runoff in the entire upstream catchment of each river segment, <strong>simple</strong> lag based routing, and <strong>Muskingum</strong> routing scheme.</p>
<p>Each routing method is accessible through the function <em>accumulate_runoff()</em>. Since the catchment provided here is small, and the timestep in runoff is one month, we’ll just use instantaneous routing here. There would be negligible difference between lag routing and instantaneous routing in this case.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">catchment_discharge &lt;-<span class="st"> </span><span class="kw"><a href="../reference/accumulate_runoff.html">accumulate_runoff</a></span>(catchment_downscaled,
                                         <span class="dt">method =</span> <span class="st">"simple"</span>)
river_discharge &lt;-<span class="st"> </span><span class="kw"><a href="../reference/accumulate_runoff.html">accumulate_runoff</a></span>(river_downscaled,
                                     <span class="dt">method =</span> <span class="st">"simple"</span>)</code></pre></div>
<p>We can also plot the estimated discharge from the two approaches at segment 180 by accessing the new list column <em>discharge_ts</em>. The predictions can be very different.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">plotdata2 &lt;-<span class="st"> </span><span class="kw">left_join</span>(catchment_discharge<span class="op">$</span>discharge_ts<span class="op">$</span><span class="st">`</span><span class="dt">200</span><span class="st">`</span>, 
                      river_discharge<span class="op">$</span>discharge_ts<span class="op">$</span><span class="st">`</span><span class="dt">200</span><span class="st">`</span>,
                      <span class="dt">by=</span><span class="st">"Date"</span>)
<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/colnames">colnames</a></span>(plotdata2) &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>(<span class="st">"Date"</span>, <span class="st">"Catchment"</span>, <span class="st">"River"</span>)
plotdata2 &lt;-<span class="st"> </span><span class="kw">gather</span>(plotdata2, 
                   Approach,
                   Discharge,
                   <span class="op">-</span>Date)

<span class="kw">ggplot</span>(plotdata2, <span class="kw">aes</span>(Date, Discharge, <span class="dt">color=</span>Approach)) <span class="op">+</span><span class="st"> </span>
<span class="st">    </span><span class="kw">geom_line</span>() <span class="op">+</span>
<span class="st">    </span><span class="kw">labs</span>(<span class="dt">title =</span> <span class="st">"Downscaled discharge at river segment 200"</span>,
         <span class="dt">y =</span> <span class="st">'Q m3/s'</span>,
         <span class="dt">x =</span> <span class="ot">NULL</span>)</code></pre></div>
<p><img src="hydrostreamer_simple_tutorial_files/figure-html/unnamed-chunk-10-1.png" width="700"> As seen from the plot, the two approaches can lead into very different estimations in small catchments - but as the river basin size increases, their predictions come closer and closer to one another.</p>
<p>We recommend that segment specific catchments be used instead of river lines for weighting whenever possible, because it creates more realistic division of runoff into the river segments.</p>
</div>
<div id="exporting" class="section level2">
<h2 class="hasAnchor">
<a href="#exporting" class="anchor"></a>Exporting</h2>
<p><em>hydrostreamer</em> also contains a function to export the results as a GeoPackage, since it is much easier to explore the data in a GIS software with GUI.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># HSwrite(catchment_discharge, "downscaled_streamflow.gpkg")</span>
<span class="co"># HSwrite(catchment_discharge, "downscaled_streamflow", what = "discharge")</span></code></pre></div>
</div>
<div id="references" class="section level2">
<h2 class="hasAnchor">
<a href="#references" class="anchor"></a>References</h2>
<p>T. Tadono, H. Ishida, F. Oda, S. Naito, K. Minakawa, H. Iwamoto : Precise Global DEM Generation By ALOS PRISM, ISPRS Annals of the Photogrammetry, Remote Sensing and Spatial Information Sciences, Vol.II-4, pp.71-76, 2014.</p>
<p>Hobeichi, S., Abramowitz, G., Evans, J., and Beck, H. E.: Linear Optimal Runoff Aggregate (LORA): a global gridded synthesis runoff product, Hydrol. Earth Syst. Sci., 23, 851-870, <a href="https://doi.org/10.5194/hess-23-851-2019" class="uri">https://doi.org/10.5194/hess-23-851-2019</a>, 2019.</p>
</div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="sidebar">
        <div id="tocnav">
      <h2 class="hasAnchor">
<a href="#tocnav" class="anchor"></a>Contents</h2>
      <ul class="nav nav-pills nav-stacked">
<li>
<a href="#using-hydrostreamer">Using <strong>hydrostreamer</strong></a><ul class="nav nav-pills nav-stacked">
<li><a href="#converting-raster-runoff-to-a-polygon-network">1. Converting raster runoff to a polygon network</a></li>
      <li><a href="#compute-weights-for-downscaling">2. Compute weights for downscaling</a></li>
      <li><a href="#downscale-runoff">3. downscale runoff</a></li>
      <li><a href="#apply-river-routing">4. Apply river routing</a></li>
      <li><a href="#exporting">Exporting</a></li>
      <li><a href="#references">References</a></li>
      </ul>
</li>
      </ul>
</div>
      </div>

</div>


      <footer><div class="copyright">
  <p>Developed by Marko Kallio, Vili Virkki.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.3.0.</p>
</div>
      </footer>
</div>

  

  </body>
</html>
